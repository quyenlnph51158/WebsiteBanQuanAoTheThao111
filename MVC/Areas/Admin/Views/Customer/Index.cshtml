@model IEnumerable<API.Domain.DTOs.CustomerDto>
@{
    ViewData["Title"] = "Danh sách khách hàng";
}
@section Styles {
    <style>
        .table td, .table th {
            max-width: 120px;
            word-break: break-word;
            white-space: normal;
        }
    </style>
}

<section class="table-components">
    <div class="container-fluid">
        <div class="title-wrapper pt-30">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="title">
                        <h2>Danh sách khách hàng</h2>
                    </div>
                </div>
            </div>
        </div>

        <div id="bulkActionBar" class="bg-light border-top p-3 d-flex justify-content-between align-items-center mb-3" style="display: none;">
            <div id="selectedCount">Đã chọn <strong>0</strong> khách hàng</div>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-success" onclick="setBulkStatus('Active')">Kích hoạt</button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="setBulkStatus('Disable')">Vô hiệu hóa</button>
            </div>
        </div>
        
        <div class="tables-wrapper">
            
            <div class="row">
                <div class="col-lg-12">
                    <div class="card-style mb-30">
                        
                        <div class="table-wrapper table-responsive">
                            <table id="customerTable" class="table align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th><input type="checkbox" id="selectAll" onclick="toggleAll(this)" /></th>
                                        <th>Tên</th>
                                        <th>Email</th>
                                        <th>Điện thoại</th>
                                        <th>Giới tính</th>
                                        <th>Trạng thái</th>
                                        <th>Ngày sinh</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var customer in Model)
                                    {
                                        <tr>
                                            <td><input type="checkbox" class="row-checkbox" value="@customer.Id" onclick="updateSelected()" /></td>
                                            <td>@customer.Fullname</td>
                                            <td>@customer.Email</td>
                                            <td>@customer.PhoneNumber</td>
                                            <td>
                                                @(customer.Gender == null
                                                                                            ? "Chưa xác định"
                                                                                            : customer.Gender == DAL_Empty.Models.GenderEnum.Nam
                                                                                            ? "Nam"
                                                                                            : customer.Gender == DAL_Empty.Models.GenderEnum.Nu
                                                                                            ? "Nữ"
                                                                                            : customer.Gender == DAL_Empty.Models.GenderEnum.Khac
                                                                                            ? "Khác"
                                                                                            : "Chưa xác định")
                                        </td>

                                            <td>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input toggle-status"
                                                           type="checkbox"
                                                           role="switch"
                                                           data-id="@customer.Id"
                                                    @(customer.Status == "Active" ? "checked" : "") />
                                                </div>
                                            </td>
                                            <td>@customer.Birthday</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        function setBulkStatus(status) {
            const ids = Array.from(document.querySelectorAll('.row-checkbox:checked'))
                .map(cb => cb.value);

            if (ids.length === 0) {
                alert("Vui lòng chọn ít nhất một khách hàng!");
                return;
            }

            fetch("/Admin/Customer/UpdateStatusBulk", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ids: ids, status: status })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) location.reload();
                else alert("Cập nhật trạng thái thất bại!");
            })
            .catch(() => alert("Đã xảy ra lỗi khi cập nhật trạng thái"));
        }

        function toggleAll(source) {
            document.querySelectorAll(".row-checkbox").forEach(cb => cb.checked = source.checked);
            updateSelected();
        }

        function updateSelected() {
            const count = document.querySelectorAll(".row-checkbox:checked").length;
            const bulkBar = document.getElementById("bulkActionBar");
            const countSpan = document.getElementById("selectedCount");
            bulkBar.style.display = count > 0 ? 'flex' : 'none';
            countSpan.innerHTML = `Đã chọn <strong>${count}</strong> khách hàng`;
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".toggle-status").forEach(function (toggle) {
                toggle.addEventListener("change", function () {
                    const id = this.getAttribute("data-id");
                    const isChecked = this.checked;
                    const newStatus = isChecked ? "Active" : "Disable";

                    fetch(`/Admin/Customer/UpdateStatus/${id}?status=${newStatus}`, { method: "POST" })
                        .then(res => { if (!res.ok) throw new Error(); })
                        .catch(() => {
                            alert("Đã xảy ra lỗi khi cập nhật trạng thái");
                            this.checked = !isChecked;
                        });
                });
            });

            $('#customerTable').DataTable({
                language: {
                    search: "Tìm kiếm:",
                    lengthMenu: "Hiển thị _MENU_ dòng",
                    info: "Hiển thị _START_ đến _END_ của _TOTAL_ dòng",
                    paginate: { first: "Đầu", last: "Cuối", next: "→", previous: "←" },
                    zeroRecords: "Không tìm thấy dữ liệu phù hợp",
                    infoEmpty: "Không có dữ liệu",
                    infoFiltered: "(lọc từ tổng _MAX_ dòng)"
                },
                columnDefs: [{ targets: [0, 6], orderable: false }]
            });
        });
    </script>
}
